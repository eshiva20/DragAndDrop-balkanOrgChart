<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
      rel="stylesheet"
    />

    <title>Drag Drop Chart</title>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        overflow: hidden;
        font-family: "Lato", serif;
        background: #353c48;
      }

      .header {
        height: 70px;
        background: #fcfbfc;
        border-bottom: 0.5px solid #d2d1d2;
      }
      .content {
        display: flex;
      }
      .organo-chart {
        padding: 10px;
        width: calc(100% - 40px);
        background: #353c48 !important;
      }
      #tree {
        height: calc(100vh - 92px) !important;
        background-color: transparent;
      }
      .sidebar {
        width: 30%;
        padding: 10px;
        color: #fff;
        background: #252b34;
        overflow-y: auto;
      }
      .card {
        background-color: #1a2024;
        margin: 10px;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .card img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 15px;
      }
      .card .info {
        color: #cdcdcd;
      }
      .card .name {
        font-size: 16px;
        font-weight: 500;
        color: white;
      }
      .boc-light {
        font-family: "Lato", serif !important;
      }
      .boc-edit-form-instruments {
        min-height: 0px !important;
        margin: 10px 0px !important;
      }
      .boc-edit-form-avatar {
        box-shadow: none !important;
        width: 120px !important;
        height: 120px !important;
        top: 60px !important;
      }
      .boc-search {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <section class="main">
      <header class="header">This is Header</header>
      <div class="content">
        <div class="organo-chart">
          <div id="tree"></div>
        </div>
        <div class="sidebar" id="sidebar">This is Sidebar</div>
      </div>
    </section>
    <script src="https://balkan.app/js/OrgChart.js"></script>
    <script>
      async function fetchChartData() {
        try {
          const data = [
            {
              id: "1",
              name: "William",
              position: "CEO",
              location: "UK, London",
              department: "Finance",
              img: "https://cdn.balkan.app/shared/1.jpg",
            },
            {
              id: "2",
              pid: "1",
              name: "Jolly",
              position: "CEO",
              location: "UK, London",
              department: "Design",
              img: "https://cdn.balkan.app/shared/2.jpg",
            },
            {
              id: "3",
              pid: "1",
              name: "Lisa",
              position: "CEO",
              location: "UK, London",
              department: "Human Resources",
              img: "https://cdn.balkan.app/shared/3.jpg",
            },
            {
              id: "4",
              pid: "1",
              name: "Edward",
              position: "CEO",
              location: "UK, London",
              department: "Sales",
              img: "https://cdn.balkan.app/shared/4.jpg",
            },
            {
              id: "5",
              pid: "2",
              name: "Amin",
              position: "CEO",
              location: "UK, London",
              department: "Procrument",
              img: "https://cdn.balkan.app/shared/5.jpg",
            },
          ];

          chart.load(data);

          const sidebarData = [
            {
              id: "6",
              name: "Shiva",
              position: "Software Developer",
              location: "Mumbai, Maharastra",
              department: "IT",
              img: "https://cdn.balkan.app/shared/9.jpg",
            },
            {
              id: "7",
              name: "Rishi",
              position: "Backend Developer",
              location: "Chandigarh, Punjab",
              department: "IT",
              img: "https://cdn.balkan.app/shared/11.jpg",
            },
            {
              id: "8",
              name: "Prasanna",
              position: "Mobile App Developer",
              location: "Pune, Maharastra",
              department: "IT",
              img: "https://cdn.balkan.app/shared/12.jpg",
            },
          ];

          generateSidebarCards(sidebarData);
          return data;
        } catch (error) {
          console.error("Error fetching org chart data:", error);
        }
      }

      // Generate cards in the sidebar
      function generateSidebarCards(data) {
        const sidebar = document.getElementById("sidebar");
        sidebar.innerHTML = ""; // Clear existing content

        data.forEach((node) => {
          const card = document.createElement("div");
          card.classList.add("card");
          card.draggable = true;
          card.dataset.id = node.id;

          card.innerHTML = `
            <img src="${node.img}" alt="${node.name}">
            <div class="info">
              <div class="name">${node.name}</div>
              <div class="position">${node.position}</div>
              <div class="department">${node.department}</div>
              <div class="location">${node.location}</div>
            </div>
          `;

          card.addEventListener("dragstart", handleDragStart);
          sidebar.appendChild(card);
        });
      }

      function handleDragStart(e) {
        const cardData = {
          id: e.target.dataset.id,
          name: e.target.querySelector(".name").innerText,
          position: e.target.querySelector(".position").innerText,
          department: e.target.querySelector(".department").innerText,
          location: e.target.querySelector(".location").innerText,
          img: e.target.querySelector("img").src,
        };

        e.dataTransfer.setData("cardData", JSON.stringify(cardData));
      }

      function handleDrop(e) {
        e.preventDefault();

        const draggedCardData = JSON.parse(e.dataTransfer.getData("cardData")); // Get dragged card data
        const targetNode = e.target.closest("g.node"); // Find the closest 'g.node' element

        if (!targetNode) {
          console.error("Invalid drop target. No node found.");
          alert("Please drop the card on a valid node in the chart.");
          return;
        }

        const targetNodeId = targetNode.getAttribute("data-n-id");

        if (!targetNodeId) {
          console.error("No node ID found in the target node.");
          return;
        }

        // Create a new node object with the dragged card data and set its parent ID
        const newNode = {
          id: `${draggedCardData.id}`, // Use the dragged card's ID
          pid: targetNodeId, // Make it a child of the target node
          name: draggedCardData.name, // Use the dragged card's data
          position: draggedCardData.position,
          department: draggedCardData.department,
          location: draggedCardData.location,
          img: draggedCardData.img,
        };

        // Add the new node to the chart (OrgChart)
        chart.addNode(newNode);

        // Optionally, update your backend or handle the node creation in your system
        updateChart(newNode);
      }

      function handleDragOver(e) {
        e.preventDefault(); // Allow drop
      }

      async function updateChart(node) {
        console.log("updated node:", node);
        try {
          const response = await fetch(
            "https://api.example.com/updateOrgChartNode",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(node),
            }
          );

          if (!response.ok) {
            console.error("Failed to update node:", await response.text());
          } else {
            console.log("Node updated successfully:", node);
          }
        } catch (error) {
          console.error("Error updating node:", error);
        }
      }

      OrgChart.templates.base = Object.assign({}, OrgChart.templates.base, {
        size: [250, 105],
        node: `<rect x="0" y="0" height="105" width="250" fill="#1A2024" stroke-width="1" stroke="#FFFFFF30" rx="7" ry="7" ></rect>`,
        field_0: `<text style="font-size: 18px; font-weight:500" fill="#ffffff" x="90" y="30" text-anchor="left">{val}</text>`,
        field_1: `<text style="font-size: 14px;" fill="#CDCDCD" x="90" y="50" text-anchor="left">{val}</text>`,
        field_2: `<text style="font-size: 14px;" fill="#CDCDCD" x="90" y="70" text-anchor="left">{val}</text>`,
        field_3: `<text style="font-size: 14px;" fill="#CDCDCD" x="90" y="90" text-anchor="left">{val}</text>`,
        img_0: `<clipPath id="ulaImg"><circle cx="45" cy="55" r="35"></circle></clipPath>
        <image preserveAspectRatio="xMidYMid slice" clip-path="url(#ulaImg)" xlink:href="{val}" x="10" y="20" width="70" height="70"></image>`,
      });
      OrgChart.templates.base.ripple = {
        radius: 100,
        color: "#ffffff",
        rect: null,
      };

      OrgChart.templates.base.editFormHeaderColor = "#1A2024";

      var chart = new OrgChart(document.getElementById("tree"), {
        template: "base",
        mouseScrool: OrgChart.action.none,
        enableDragDrop: true,
        nodeBinding: {
          field_0: "name",
          field_1: "position",
          field_2: "location",
          field_3: "department",
          img_0: "img",
        },
        nodes: [],
      });

      const treeContainer = document.getElementById("tree");

      chart.on("update", function (sender, oldNode, newNode) {
        updateChart(newNode);
      });

      OrgChart.templates.base.plus = "";
      OrgChart.templates.base.minus = "";

      treeContainer.addEventListener("drop", handleDrop); // Handle drop events
      treeContainer.addEventListener("dragover", handleDragOver); // Allow dragging over the chart

      fetchChartData();
    </script>
  </body>
</html>
