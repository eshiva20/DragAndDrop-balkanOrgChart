<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap"
      rel="stylesheet"
    />

    <title>Drag Drop Chart</title>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        font-family: "Lato", serif;
        background: #353c48;
      }

      .header {
        height: 70px;
        padding: 0px 20px;
        background: #fcfbfc;
        border-bottom: 0.5px solid #d2d1d2;
        display: flex;
        align-items: center;
      }
      .content {
        display: flex;
      }
      .organo-chart {
        padding: 10px;
        width: calc(100% - 40px);
        background: #353c48 !important;
      }
      #tree {
        height: calc(100vh - 92px) !important;
        background-color: transparent;
      }
      .sidebar {
        width: 30%;
        padding: 0px 12px;
        color: #fff;
        background: #252b34;
        overflow-y: auto;
      }
      .cardlists {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 240px);
        overflow-y: auto;
        padding-right: 5px;
      }
      .cardlists::-webkit-scrollbar {
        width: 5px;
        background-color: #d9d9d9;
        border-radius: 50px;
      }
      .cardlists::-webkit-scrollbar-thumb {
        background-color: #8a8a8a;
        border-radius: 50px;
        cursor: pointer;
      }
      .card {
        background-color: #1a2024;
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        border: 1px solid #ffffff2e;
      }
      .cardUpper {
        display: flex;
        align-items: center;
        border-bottom: 1px solid #333333;
        padding-bottom: 10px;
      }
      .card .employee-img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-right: 15px;
        -webkit-user-drag: none;
        border: 1px solid #311a754d;
      }
      .card .info {
        color: #cdcdcd;
        display: grid;
        gap: 2px;
      }
      .card .name {
        font-size: 18px;
        font-weight: 500;
        color: #fff;
      }
      .boc-light {
        font-family: "Lato", serif !important;
      }
      .boc-edit-form-instruments {
        min-height: 0px !important;
        margin: 10px 0px !important;
      }
      .boc-edit-form-avatar {
        box-shadow: none !important;
        width: 120px !important;
        height: 120px !important;
        top: 60px !important;
      }
      .boc-search {
        display: none !important;
      }
      .header-right {
        display: flex;
        align-items: center;
        margin-left: auto;
        margin-right: 10px;
      }
      .hbl-logo {
        width: auto;
        height: 50px;
      }
      .icons-div {
        display: flex;
        align-items: center;
        gap: 15px;
        border-right: 1px solid #d2d1d2;
        padding-right: 20px;
        height: 50px;
      }
      .icon {
        width: 25px;
        height: 25px;
        border: 1px solid #d2d1d2;
        border-radius: 5px;
        padding: 5px;
        cursor: pointer;
      }
      .profile {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-left: 20px;
        border: 0.5px solid #d2d1d2;
        border-radius: 8px;
        padding: 6px 10px;
      }
      .profile-image {
        width: 40px;
        height: auto;
        border-radius: 50%;
      }
      .profile-name,
      .profile-position {
        margin: 0px;
        font-family: "Nunito", sans-serif;
      }
      .profile-name {
        font-weight: 600;
        font-size: 18px;
      }
      .profile-position {
        color: #7a7a7a;
        font-weight: 400;
        font-size: 16px;
        line-height: 15px;
      }
      .position,
      .location {
        font-size: 14px;
        font-weight: 400;
      }
      .select-icon {
        width: 12px;
        height: auto;
        cursor: pointer;
      }
      .select-department {
        display: grid;
        gap: 8px;
        padding: 15px 0px;
        border-bottom: 1px solid #424242;
      }
      .select-department label {
        font-family: "Rubik", serif;
        font-size: 16px;
      }
      .select-department select {
        padding: 9px 7px;
        border: 1px solid #c2c2c2;
        border-radius: 10px;
        background-color: transparent;
        outline: none;
        color: #9c9c9c;
        cursor: pointer;
        font-size: 16px;
      }
      .select-department select option {
        background-color: #252b34;
        color: #fff;
      }
      .search-div {
        border: 1px solid #c2c2c2;
        padding: 9px 7px;
        border-radius: 10px;
        margin-top: 15px;
        display: flex;
        gap: 5px;
        align-items: center;
      }
      .search-icon {
        width: 18px;
        margin-bottom: 1px;
      }
      .search-input {
        width: 100%;
        background-color: transparent;
        outline: none;
        border: none;
        color: #9c9c9c;
        font-family: "Nunito", serif;
        font-size: 14px;
      }
      #sidebar-card-department {
        display: none;
      }
      .department-name {
        background-color: #b1cbff;
        color: #082152;
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .department-icon {
        width: 10px;
      }
      .cards-div {
        display: flex;
        flex-direction: column;
        gap: 7px;
      }
      .more-icon {
        margin-bottom: auto;
        margin-left: auto;
      }
      .team-members {
        background: #262d32;
        border-radius: 5px;
        color: #fff;
        padding: 4px 6px;
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .team-members span {
        margin-left: auto;
      }
      .teams-icon {
        width: 20px;
        height: auto;
        margin-right: 15px;
      }
      .teamMembers-imgDivs {
        display: flex;
        align-items: center;
      }
      .teamsMember-img {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        margin-left: -10px;
      }
    </style>
  </head>
  <body>
    <section class="main">
      <header class="header">
        <img
          src="./assets/hbl_logo.png"
          class="hbl-logo"
          alt="Health Biotech Limited"
        />
        <div class="header-right">
          <div class="icons-div">
            <img src="./assets/add_icon.png" class="icon" alt="Add Icon" />
            <img
              src="./assets/bell_icon.png"
              class="icon"
              alt="Notification Icon"
            />
          </div>
          <div class="profile">
            <img
              src="./assets/profile_image.jpg"
              class="profile-image"
              alt="Profile Image"
            />
            <div>
              <p class="profile-name">Amrit Arora</p>
              <p class="profile-position">Director</p>
            </div>
            <img
              src="./assets/select_icon.png"
              class="select-icon"
              alt="Select Icon"
            />
          </div>
        </div>
      </header>
      <div class="content">
        <div class="organo-chart">
          <div id="tree"></div>
        </div>
        <div class="sidebar" id="sidebar">
          <div class="select-department">
            <label for="department">Department</label>
            <select id="department">
              <option value="all" hidden>All</option>
              <option value="Finance">Finance</option>
              <option value="Design">Design</option>
              <option value="Human Resouce">Human Resouce</option>
              <option value="Sales">Sales</option>
              <option value="Procrument">Procrument</option>
              <option value="IT">IT</option>
            </select>
          </div>
          <div>
            <div class="search-div">
              <img
                src="./assets/search_icon.png"
                class="search-icon"
                alt="Search Icon"
              />
              <input class="search-input" placeholder="Search By Name" />
            </div>
            <div class="cardlists" id="cardlists"></div>
          </div>
        </div>
      </div>
    </section>
    <script src="https://balkan.app/js/OrgChart.js"></script>
    <script>
      const departmentColors = {
        Finance: "#b1cbff80",
        Design: "#252b3480",
        "Human Resources": "#ffdfc280",
        Sales: "#ffacc980",
        Procrument: "#c0ffd780",
        IT: "#7fdbff80",
      };

      function assignDepartmentColors(nodes) {
        return nodes.map((node) => ({
          ...node,
          departmentColor: departmentColors[node.department] || "#353c48",
        }));
      }

      async function fetchChartData() {
        try {
          const hirarchyData = [
            {
              id: "1",
              name: "William",
              position: "CEO",
              location: "UK, London",
              department: "Finance",
              img: "https://cdn.balkan.app/shared/1.jpg",
            },
            {
              id: "2",
              pid: "1",
              name: "Jolly",
              position: "CEO",
              location: "UK, London",
              department: "Design",
              img: "https://cdn.balkan.app/shared/2.jpg",
            },
            {
              id: "3",
              pid: "1",
              name: "Lisa",
              position: "CEO",
              location: "UK, London",
              department: "Human Resources",
              img: "https://cdn.balkan.app/shared/3.jpg",
            },
            {
              id: "4",
              pid: "1",
              name: "Edward",
              position: "CEO",
              location: "UK, London",
              department: "Sales",
              img: "https://cdn.balkan.app/shared/4.jpg",
            },
            {
              id: "5",
              pid: "2",
              name: "Amin",
              position: "CEO",
              location: "UK, London",
              department: "Procrument",
              img: "https://cdn.balkan.app/shared/5.jpg",
            },
          ];

          const updatedHirarchyData = assignDepartmentColors(hirarchyData);
          chart.load(updatedHirarchyData);

          const sidebarData = [
            {
              department: "Finance",
              departmentData: [
                {
                  id: "6",
                  name: "Shiva",
                  position: "Software Developer",
                  location: "Mumbai, Maharastra",
                  department: "Finance",
                  img: "https://cdn.balkan.app/shared/9.jpg",
                  teams: [
                    "https://cdn.balkan.app/shared/14.jpg",
                    "https://cdn.balkan.app/shared/15.jpg",
                    "https://cdn.balkan.app/shared/16.jpg",
                    "https://cdn.balkan.app/shared/17.jpg",
                    "https://cdn.balkan.app/shared/18.jpg",
                    "https://cdn.balkan.app/shared/19.jpg",
                    "https://cdn.balkan.app/shared/2.jpg",
                    "https://cdn.balkan.app/shared/21.jpg",
                    "https://cdn.balkan.app/shared/22.jpg",
                  ],
                },
                {
                  id: "7",
                  name: "Rishi",
                  position: "Backend Developer",
                  location: "Chandigarh, Punjab",
                  department: "Finance",
                  img: "https://cdn.balkan.app/shared/11.jpg",
                  teams: [
                    "https://cdn.balkan.app/shared/1.jpg",
                    "https://cdn.balkan.app/shared/2.jpg",
                    "https://cdn.balkan.app/shared/3.jpg",
                    "https://cdn.balkan.app/shared/4.jpg",
                    "https://cdn.balkan.app/shared/5.jpg",
                    "https://cdn.balkan.app/shared/6.jpg",
                    "https://cdn.balkan.app/shared/7.jpg",
                    "https://cdn.balkan.app/shared/8.jpg",
                    "https://cdn.balkan.app/shared/9.jpg",
                    "https://cdn.balkan.app/shared/10.jpg",
                  ],
                },
              ],
            },
            {
              department: "Procrument",
              departmentData: [
                {
                  id: "8",
                  name: "Akash",
                  position: "UI Designer",
                  location: "Chandigarh, Punjab",
                  department: "Procrument",
                  img: "https://cdn.balkan.app/shared/8.jpg",
                  teams: [
                    "https://cdn.balkan.app/shared/14.jpg",
                    "https://cdn.balkan.app/shared/15.jpg",
                    "https://cdn.balkan.app/shared/16.jpg",
                    "https://cdn.balkan.app/shared/17.jpg",
                    "https://cdn.balkan.app/shared/18.jpg",
                    "https://cdn.balkan.app/shared/19.jpg",
                    "https://cdn.balkan.app/shared/2.jpg",
                    "https://cdn.balkan.app/shared/21.jpg",
                    "https://cdn.balkan.app/shared/22.jpg",
                  ],
                },
                {
                  id: "9",
                  name: "Prasanna",
                  position: "Mobile App Developer",
                  location: "Pune, Maharastra",
                  department: "Procrument",
                  img: "https://cdn.balkan.app/shared/10.jpg",
                  teams: [
                    "https://cdn.balkan.app/shared/14.jpg",
                    "https://cdn.balkan.app/shared/15.jpg",
                    "https://cdn.balkan.app/shared/16.jpg",
                    "https://cdn.balkan.app/shared/17.jpg",
                    "https://cdn.balkan.app/shared/18.jpg",
                  ],
                },
              ],
            },
          ];
          generateSidebarCards(sidebarData);
          return updatedHirarchyData;
        } catch (error) {
          console.error("Error fetching org chart data:", error);
        }
      }

      // Generate cards in the sidebar
      function generateSidebarCards(data) {
        const cardlists = document.getElementById("cardlists");

        data.forEach((node) => {
          const departmentDiv = document.createElement("div");
          departmentDiv.classList.add("department-container");
          departmentDiv.innerHTML = `<p class="department-name">
           <img src="./assets/department_icon.png" class="department-icon" alt="Department Icon"/> Department-${node.department}</p>`;
          const cardsDiv = document.createElement("div");
          cardsDiv.classList.add("cards-div");

          node.departmentData.forEach((innerNode) => {
            const card = document.createElement("div");
            card.classList.add("card");
            card.draggable = true;
            card.dataset.id = innerNode.id;
            card.innerHTML = `
            <div class="cardUpper">
            <img src="${innerNode.img}" class="employee-img" alt="${innerNode.name}">
            <div class="info">
              <div class="name">${innerNode.name}</div>
              <div class="position">${innerNode.position}</div>
              <div id="sidebar-card-department" class="department">${innerNode.department}</div>
              <div class="location">${innerNode.location}</div>
            </div>
            <i class="fa-solid fa-ellipsis-vertical more-icon"></i>
            </div>
            <div class="team-members">
              <img src="./assets/teams_icon.png" class="teams-icon" alt="Teams Icon"/>
              <div id="teamMembers-${innerNode.id}" class="teamMembers-imgDivs"></div>
              <span>+10</span>
            </div>
          `;

            const teamMembersImgsDiv = card.querySelector(
              `#teamMembers-${innerNode.id}`
            );
            innerNode.teams.forEach((imgUrl) => {
              const teamImg = document.createElement("img");
              teamImg.src = imgUrl;
              teamImg.classList.add("teamsMember-img");
              teamImg.alt = "Team Member";
              teamMembersImgsDiv.appendChild(teamImg);
            });

            card.addEventListener("dragstart", handleDragStart);
            cardsDiv.appendChild(card);
          });

          departmentDiv.appendChild(cardsDiv);
          cardlists.appendChild(departmentDiv);
        });
      }

      function handleDragStart(e) {
        const cardData = {
          id: e.target.dataset.id,
          name: e.target.querySelector(".name").innerText,
          position: e.target.querySelector(".position").innerText,
          department: e.target.querySelector(".department").innerText,
          location: e.target.querySelector(".location").innerText,
          img: e.target.querySelector("img").src,
        };

        e.dataTransfer.setData("cardData", JSON.stringify(cardData));
      }

      function handleDrop(e) {
        e.preventDefault();

        const draggedCardData = JSON.parse(e.dataTransfer.getData("cardData"));
        const targetNode = e.target.closest("g.node");

        if (!targetNode) {
          console.error("Invalid drop target. No node found.");
          alert("Please drop the card on a valid node in the chart.");
          return;
        }

        const targetNodeId = targetNode.getAttribute("data-n-id");

        if (!targetNodeId) {
          console.error("No node ID found in the target node.");
          return;
        }

        // Create a new node object with the dragged card data and set its parent ID
        const newNode = {
          id: `${draggedCardData.id}`,
          pid: targetNodeId,
          name: draggedCardData.name,
          position: draggedCardData.position,
          department: draggedCardData.department,
          location: draggedCardData.location,
          img: draggedCardData.img,
          departmentColor:
            departmentColors[draggedCardData.department] || "#353c48",
        };

        chart.addNode(newNode);
        updateChart(newNode);
      }

      function handleDragOver(e) {
        e.preventDefault();
      }

      async function updateChart(node) {
        // console.log("updated node:", node);
        try {
          const response = await fetch(
            "https://api.example.com/updateOrgChartNode",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(node),
            }
          );

          if (!response.ok) {
            console.error("Failed to update node:", await response.text());
          } else {
            console.log("Node updated successfully:", node);
          }
        } catch (error) {
          console.error("Error updating node:", error);
        }
      }

      OrgChart.templates.base = Object.assign({}, OrgChart.templates.base, {
        size: [250, 110],
        node: `<rect x="0" y="0" height="110" width="250" fill="#1A2024" stroke-width="1" stroke="#FFFFFF30" rx="7" ry="7" ></rect>`,
        field_0: `<text style="font-size: 18px; font-weight:500" fill="#ffffff" x="90" y="30" text-anchor="left">{val}</text>`,
        field_1: `<text style="font-size: 14px;" fill="#CDCDCD" x="90" y="50" text-anchor="left">{val}</text>`,
        field_2: `<text style="font-size: 14px;" fill="#CDCDCD" x="90" y="70" text-anchor="left">{val}</text>`,
        custom_field_3: `<rect x="85" y="77" height="22" width="140" fill="{val}" rx="4" ry="4"></rect>`,
        field_3: `<text style="font-size: 14px;" fill="#ffffff" x="90" y="93" text-anchor="left">{val}</text>`,
        img_0: `<clipPath id="ulaImg"><circle cx="45" cy="55" r="35"></circle></clipPath>
        <image preserveAspectRatio="xMidYMid slice" clip-path="url(#ulaImg)" xlink:href="{val}" x="10" y="20" width="70" height="70"></image>`,
      });
      OrgChart.templates.base.ripple = {
        radius: 100,
        color: "#ffffff",
        rect: null,
      };

      OrgChart.templates.base.editFormHeaderColor = "#1A2024";

      var chart = new OrgChart(document.getElementById("tree"), {
        template: "base",
        mouseScrool: OrgChart.action.none,
        enableDragDrop: true,
        editForm: {
          readOnly: true,
          buttons: {
            share: null,
            pdf: null,
            remove: {
              icon: OrgChart.icon.remove(24, 24, "#fff"),
              text: "Remove",
              hideIfDetailsMode: false,
            },
          },
        },
        nodeBinding: {
          field_0: "name",
          field_1: "position",
          field_2: "location",
          field_3: "department",
          custom_field_3: "departmentColor",
          img_0: "img",
        },
        nodes: [],
      });

      const treeContainer = document.getElementById("tree");

      chart.on("update", function (sender, oldNode, newNode) {
        updateChart(newNode);
      });

      chart.on("remove", function (sender, nodeId) {
        const removedNode = chart.get(nodeId); // Get details of the removed node if needed
        console.log("removedNode", removedNode);

        const updatedData = { ...removedNode, pid: null };
        console.log("updatedData", updatedData);

        // const parentId = removedNode.pid;
        // if (parentId) {
        //   const parentNode = chart.get(parentId);
        //   console.log("Parent Node:", parentNode);

        //   const updateData = {
        //     id: parentNode.id,
        //     childRemoved: nodeId,
        //   };

        //   updateChart(updateData);
        // } else {
        //   console.log("Removed node had no parent.");
        // }

        // console.log(`Node with ID ${nodeId} removed.`);
      });

      OrgChart.templates.base.plus = "";
      OrgChart.templates.base.minus = "";

      treeContainer.addEventListener("drop", handleDrop);
      treeContainer.addEventListener("dragover", handleDragOver);

      fetchChartData();
    </script>
  </body>
</html>
